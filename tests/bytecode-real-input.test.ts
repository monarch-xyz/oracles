import { describe, expect, it } from "vitest";
import { classifyOracleBytecode } from "../src/sources/oracleBytecodeValidation.js";
import { isMorphoChainlinkOracleV1Bytecode } from "../src/sources/oracleV1Detector.js";
import { isMorphoChainlinkOracleV2Bytecode } from "../src/sources/oracleV2BytecodeDetector.js";
import {
  isPendleChainlinkOracleFeedBytecode,
  isPendleLinearDiscountFeedBytecode,
} from "../src/sources/pendleFeedDetector.js";

/**
 * Paste real deployed bytecodes here.
 * Use full hex with 0x prefix.
 */
const REAL_V1_BYTECODE =
  "0x60806040818152600436101561001457600080fd5b600091823560e01c908163411557d1146104455750806356095e11146103d7578063a035b1fe14610277578063acfbd39e14610209578063ce4b5bbe146101b1578063d6c843ca14610159578063dc53858c146100eb5763f50a47181461007a57600080fd5b346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000fdfd9c85ad200c506cf9e21f1fd8dd01932fbb23168152f35b5080fd5b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000f4030086522a5beea4988f8ca5b36dbc97bee88c168152f35b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e757602090517f00000000000000000000000000000000000000000000000000000000000000018152f35b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e757602090517f00000000000000000000000000000000000000000052b7d2dcc80cd2e40000008152f35b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e7576020906103d061035461032b6102fc7f00000000000000000000000000000000000000000000000000000000000000017f0000000000000000000000000000000000000000000000000000000000000000610821565b6103257f000000000000000000000000fdfd9c85ad200c506cf9e21f1fd8dd01932fbb2361067c565b906104b3565b6103257f000000000000000000000000f4030086522a5beea4988f8ca5b36dbc97bee88c61067c565b6103a96103807f0000000000000000000000008fffffd4afb6115b954bd326cbe7b4ba576818f661067c565b6103257f000000000000000000000000000000000000000000000000000000000000000061067c565b907f00000000000000000000000000000000000000000052b7d2dcc80cd2e40000006104f5565b9051908152f35b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000008fffffd4afb6115b954bd326cbe7b4ba576818f6168152f35b8390346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e75760209073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b818102929181159184041417156104c657565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b9091828202917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff848209938380861095039480860395146105b357848311156105895782910981600003821680920460028082600302188083028203028083028203028083028203028083028203028083028203028092029003029360018380600003040190848311900302920304170290565b60046040517f227bc153000000000000000000000000000000000000000000000000000000008152fd5b5050809250156105c1570490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b90601f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0910116810190811067ffffffffffffffff82111761063157604052565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b519069ffffffffffffffffffff8216820361067757565b600080fd5b73ffffffffffffffffffffffffffffffffffffffff16801561081b5760049060a06040918251938480927ffeaf968c0000000000000000000000000000000000000000000000000000000082525afa918215610810576000926107bf575b50805181810181811067ffffffffffffffff821117610631578252600f81526020917f6e6567617469766520616e737765720000000000000000000000000000000000838301526000841261072f5750505090565b5180927f08c379a000000000000000000000000000000000000000000000000000000000825280600483015282519283602484015260005b8481106107a8575050507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f836000604480968601015201168101030190fd5b818101830151868201604401528593508201610767565b909160a0823d8211610808575b816107d960a093836105f0565b8101031261080557506107eb81610660565b506107fd608060208301519201610660565b5090386106da565b80fd5b3d91506107cc565b50513d6000823e3d90fd5b50600190565b73ffffffffffffffffffffffffffffffffffffffff169081156108c0576020906024604051809481937f07a2d13a00000000000000000000000000000000000000000000000000000000835260048301525afa9081156108b457600091610886575090565b906020823d82116108ac575b8161089f602093836105f0565b8101031261080557505190565b3d9150610892565b6040513d6000823e3d90fd5b505060019056fea26469706673582212206d1afbf1b139d06c6beb42eb513c9aba924c412a2e640fa2263a47dbeb3a2fb764736f6c63430008150033";

// HyperEVM V2 oracles!
const REAL_V2_BYTECODE =
  "0x60806040818152600436101561001457600080fd5b600091823560e01c908163054f7ac014610584575080632e6f20a614610516578063461739d2146104be57806356095e1114610450578063a035b1fe146102a3578063acfbd39e14610235578063ce4b5bbe146101dd578063dc53858c1461016f578063eaa2d7b4146101015763f50a47181461009057600080fd5b346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000ffe5f5e9e18b88fbdd7e28d4a583a111c874fb47168152f35b5080fd5b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd57602090517f0000000000000000000000000000000000000000204fce5e3e250261100000008152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020906104496103806103576103287f00000000000000000000000000000000000000000000000000000000000000017f000000000000000000000000000000000000000000000000000000000000000061094a565b6103517f000000000000000000000000ffe5f5e9e18b88fbdd7e28d4a583a111c874fb476107a5565b906105dc565b6103517f00000000000000000000000000000000000000000000000000000000000000006107a5565b6104226103f96103d07f00000000000000000000000000000000000000000000000000000000000000017f000000000000000000000000000000000000000000000000000000000000000061094a565b6103517f00000000000000000000000000000000000000000000000000000000000000006107a5565b6103517f00000000000000000000000000000000000000000000000000000000000000006107a5565b907f0000000000000000000000000000000000000000204fce5e3e2502611000000061061e565b9051908152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd57602090517f00000000000000000000000000000000000000000000000000000000000000018152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b8390346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020907f00000000000000000000000000000000000000000000000000000000000000018152f35b818102929181159184041417156105ef57565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b9091828202917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff848209938380861095039480860395146106dc57848311156106b25782910981600003821680920460028082600302188083028203028083028203028083028203028083028203028083028203028092029003029360018380600003040190848311900302920304170290565b60046040517f227bc153000000000000000000000000000000000000000000000000000000008152fd5b5050809250156106ea570490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b90601f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0910116810190811067ffffffffffffffff82111761075a57604052565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b519069ffffffffffffffffffff821682036107a057565b600080fd5b73ffffffffffffffffffffffffffffffffffffffff1680156109445760049060a06040918251938480927ffeaf968c0000000000000000000000000000000000000000000000000000000082525afa918215610939576000926108e8575b50805181810181811067ffffffffffffffff82111761075a578252600f81526020917f6e6567617469766520616e73776572000000000000000000000000000000000083830152600084126108585750505090565b5180927f08c379a000000000000000000000000000000000000000000000000000000000825280600483015282519283602484015260005b8481106108d1575050507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f836000604480968601015201168101030190fd5b818101830151868201604401528593508201610890565b909160a0823d8211610931575b8161090260a09383610719565b8101031261092e575061091481610789565b50610926608060208301519201610789565b509038610803565b80fd5b3d91506108f5565b50513d6000823e3d90fd5b50600190565b73ffffffffffffffffffffffffffffffffffffffff169081156109e9576020906024604051809481937f07a2d13a00000000000000000000000000000000000000000000000000000000835260048301525afa9081156109dd576000916109af575090565b906020823d82116109d5575b816109c860209383610719565b8101031261092e57505190565b3d91506109bb565b6040513d6000823e3d90fd5b505060019056fea164736f6c6343000815000a";
const REAL_V2_BYTECODE_2 =
  "0x60806040818152600436101561001457600080fd5b600091823560e01c908163054f7ac014610584575080632e6f20a614610516578063461739d2146104be57806356095e1114610450578063a035b1fe146102a3578063acfbd39e14610235578063ce4b5bbe146101dd578063dc53858c1461016f578063eaa2d7b4146101015763f50a47181461009057600080fd5b346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f00000000000000000000000082721e2c5ef2df1796b09728376361892b155594168152f35b5080fd5b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd57602090517f00000000000000000000000000000000000000000000d3c21bcecceda10000008152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020906104496103806103576103287f00000000000000000000000000000000000000000000000000000000000000017f000000000000000000000000000000000000000000000000000000000000000061094a565b6103517f00000000000000000000000082721e2c5ef2df1796b09728376361892b1555946107a5565b906105dc565b6103517f00000000000000000000000000000000000000000000000000000000000000006107a5565b6104226103f96103d07f00000000000000000000000000000000000000000000000000000000000000017f000000000000000000000000000000000000000000000000000000000000000061094a565b6103517f0000000000000000000000005e21f6530f656a38cae4f55500944753f662d1846107a5565b6103517f00000000000000000000000000000000000000000000000000000000000000006107a5565b907f00000000000000000000000000000000000000000000d3c21bcecceda100000061061e565b9051908152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000005e21f6530f656a38cae4f55500944753f662d184168152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd57602090517f00000000000000000000000000000000000000000000000000000000000000018152f35b50346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b8390346100fd57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100fd576020907f00000000000000000000000000000000000000000000000000000000000000018152f35b818102929181159184041417156105ef57565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b9091828202917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff848209938380861095039480860395146106dc57848311156106b25782910981600003821680920460028082600302188083028203028083028203028083028203028083028203028083028203028092029003029360018380600003040190848311900302920304170290565b60046040517f227bc153000000000000000000000000000000000000000000000000000000008152fd5b5050809250156106ea570490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b90601f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0910116810190811067ffffffffffffffff82111761075a57604052565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b519069ffffffffffffffffffff821682036107a057565b600080fd5b73ffffffffffffffffffffffffffffffffffffffff1680156109445760049060a06040918251938480927ffeaf968c0000000000000000000000000000000000000000000000000000000082525afa918215610939576000926108e8575b50805181810181811067ffffffffffffffff82111761075a578252600f81526020917f6e6567617469766520616e73776572000000000000000000000000000000000083830152600084126108585750505090565b5180927f08c379a000000000000000000000000000000000000000000000000000000000825280600483015282519283602484015260005b8481106108d1575050507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f836000604480968601015201168101030190fd5b818101830151868201604401528593508201610890565b909160a0823d8211610931575b8161090260a09383610719565b8101031261092e575061091481610789565b50610926608060208301519201610789565b509038610803565b80fd5b3d91506108f5565b50513d6000823e3d90fd5b50600190565b73ffffffffffffffffffffffffffffffffffffffff169081156109e9576020906024604051809481937f07a2d13a00000000000000000000000000000000000000000000000000000000835260048301525afa9081156109dd576000916109af575090565b906020823d82116109d5575b816109c860209383610719565b8101031261092e57505190565b3d91506109bb565b6040513d6000823e3d90fd5b505060019056fea164736f6c6343000815000a";

const REAL_PENDLE_FEED_BYTECODE =
  "0x6080806040526004361015610012575f80fd5b5f3560e01c908163313ce567146101f857508063ea56d3db1461018a5763feaf968c1461003d575f80fd5b34610173575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610173576040517ffeaf968c00000000000000000000000000000000000000000000000000000000815260a08160048173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000008509ff79d9ca53f5a5c41544b9e713cc98ee7fa8165afa90811561017f575f905f5f915f94610114575b509269ffffffffffffffffffff9160a094836040519516855260208501526040840152426060840152166080820152f35b935050505060a0813d60a011610177575b8161013260a093836102e0565b81010312610173578069ffffffffffffffffffff61015160a09361034e565b9160208101519261016960806040840151930161034e565b94509290916100e3565b5f80fd5b3d9150610125565b6040513d5f823e3d90fd5b34610173575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261017357602060405173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000008509ff79d9ca53f5a5c41544b9e713cc98ee7fa8168152f35b34610173575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610173577f313ce56700000000000000000000000000000000000000000000000000000000815260208160048173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000008509ff79d9ca53f5a5c41544b9e713cc98ee7fa8165afa801561017f575f906102a3575b60209060ff60405191168152f35b506020813d6020116102d8575b816102bd602093836102e0565b81010312610173575160ff8116810361017357602090610295565b3d91506102b0565b90601f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0910116810190811067ffffffffffffffff82111761032157604052565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b519069ffffffffffffffffffff821682036101735756fea2646970667358221220ff5fe8c76ec21ed4777097f5520a3819e2f1a28344938b950c70281fd22ff52464736f6c634300081e0033";
const REAL_PENDLE_FEED_BYTECODE_2 =
  "0x6080806040526004361015610012575f80fd5b5f3560e01c908163313ce567146101f857508063ea56d3db1461018a5763feaf968c1461003d575f80fd5b34610173575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610173576040517ffeaf968c00000000000000000000000000000000000000000000000000000000815260a08160048173ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000d69aaa141e63adfa1399075fb9533741a2985fa7165afa90811561017f575f905f5f915f94610114575b509269ffffffffffffffffffff9160a094836040519516855260208501526040840152426060840152166080820152f35b935050505060a0813d60a011610177575b8161013260a093836102e0565b81010312610173578069ffffffffffffffffffff61015160a09361034e565b9160208101519261016960806040840151930161034e565b94509290916100e3565b5f80fd5b3d9150610125565b6040513d5f823e3d90fd5b34610173575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261017357602060405173ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000d69aaa141e63adfa1399075fb9533741a2985fa7168152f35b34610173575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610173577f313ce56700000000000000000000000000000000000000000000000000000000815260208160048173ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000d69aaa141e63adfa1399075fb9533741a2985fa7165afa801561017f575f906102a3575b60209060ff60405191168152f35b506020813d6020116102d8575b816102bd602093836102e0565b81010312610173575160ff8116810361017357602090610295565b3d91506102b0565b90601f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0910116810190811067ffffffffffffffff82111761032157604052565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b519069ffffffffffffffffffff821682036101735756fea2646970667358221220ff5fe8c76ec21ed4777097f5520a3819e2f1a28344938b950c70281fd22ff52464736f6c634300081e0033";


describe("real bytecode validation inputs", () => {
  it("validates real V1 bytecode", () => {
    expect(isMorphoChainlinkOracleV1Bytecode(REAL_V1_BYTECODE)).toBe(true);
    expect(classifyOracleBytecode(REAL_V1_BYTECODE)).toBe("v1");
  });

  it("validates real V2 bytecode", () => {
    expect(isMorphoChainlinkOracleV2Bytecode(REAL_V2_BYTECODE)).toBe(true);
    expect(classifyOracleBytecode(REAL_V2_BYTECODE)).toBe("v2");
  });

  it("validates second real V2 bytecode", () => {
    expect(isMorphoChainlinkOracleV2Bytecode(REAL_V2_BYTECODE_2)).toBe(true);
    expect(classifyOracleBytecode(REAL_V2_BYTECODE_2)).toBe("v2");
  });

  it("validates real Pendle feed bytecode", () => {
    expect(isPendleLinearDiscountFeedBytecode(REAL_PENDLE_FEED_BYTECODE)).toBe(true);
  });

  it("validates second real Pendle feed bytecode", () => {
    expect(isPendleLinearDiscountFeedBytecode(REAL_PENDLE_FEED_BYTECODE_2)).toBe(true);
  });
});
