import { describe, expect, it } from "vitest";
import {
  MORPHO_CHAINLINK_ORACLE_V2_COMMON,
} from "../src/bytecodes/oracle-bytecode-constants.js";
import { classifyOracleBytecode } from "../src/sources/oracleBytecodeValidation.js";
import { isMorphoChainlinkOracleV1Bytecode } from "../src/sources/oracleV1Detector.js";
import { isMorphoChainlinkOracleV2Bytecode } from "../src/sources/oracleV2BytecodeDetector.js";

// Legit MorphoChainlinkOracle V1 bytecode to test: https://etherscan.io/address/0xdc6fd5831277c693b1054e19e94047cb37c77615#code
const MORPHO_CHAINLINK_ORACLE_V1_TEST_BYTECODE = "0x60806040818152600436101561001457600080fd5b600091823560e01c908163411557d1146104455750806356095e11146103d7578063a035b1fe14610277578063acfbd39e14610209578063ce4b5bbe146101b1578063d6c843ca14610159578063dc53858c146100eb5763f50a47181461007a57600080fd5b346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b5080fd5b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e757602090517f00000000000000000000000000000000000000000000000000000000000000018152f35b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e757602090517f00000000000000000000000000000b7abc627050305adf14a3d9e400000000008152f35b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e7576020906103d061035461032b6102fc7f00000000000000000000000000000000000000000000000000000000000000017f0000000000000000000000000000000000000000000000000000000000000000610821565b6103257f000000000000000000000000000000000000000000000000000000000000000061067c565b906104b3565b6103257f000000000000000000000000000000000000000000000000000000000000000061067c565b6103a96103807f000000000000000000000000986b5e1e1755e3c2440e960477f25201b0a8bbd461067c565b6103257f000000000000000000000000000000000000000000000000000000000000000061067c565b907f00000000000000000000000000000b7abc627050305adf14a3d9e400000000006104f5565b9051908152f35b50346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000986b5e1e1755e3c2440e960477f25201b0a8bbd4168152f35b8390346100e757817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100e75760209073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b818102929181159184041417156104c657565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b9091828202917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff848209938380861095039480860395146105b357848311156105895782910981600003821680920460028082600302188083028203028083028203028083028203028083028203028083028203028092029003029360018380600003040190848311900302920304170290565b60046040517f227bc153000000000000000000000000000000000000000000000000000000008152fd5b5050809250156105c1570490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b90601f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0910116810190811067ffffffffffffffff82111761063157604052565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b519069ffffffffffffffffffff8216820361067757565b600080fd5b73ffffffffffffffffffffffffffffffffffffffff16801561081b5760049060a06040918251938480927ffeaf968c0000000000000000000000000000000000000000000000000000000082525afa918215610810576000926107bf575b50805181810181811067ffffffffffffffff821117610631578252600f81526020917f6e6567617469766520616e737765720000000000000000000000000000000000838301526000841261072f5750505090565b5180927f08c379a000000000000000000000000000000000000000000000000000000000825280600483015282519283602484015260005b8481106107a8575050507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f836000604480968601015201168101030190fd5b818101830151868201604401528593508201610767565b909160a0823d8211610808575b816107d960a093836105f0565b8101031261080557506107eb81610660565b506107fd608060208301519201610660565b5090386106da565b80fd5b3d91506107cc565b50513d6000823e3d90fd5b50600190565b73ffffffffffffffffffffffffffffffffffffffff169081156108c0576020906024604051809481937f07a2d13a00000000000000000000000000000000000000000000000000000000835260048301525afa9081156108b457600091610886575090565b906020823d82116108ac575b8161089f602093836105f0565b8101031261080557505190565b3d9150610892565b6040513d6000823e3d90fd5b505060019056fea26469706673582212206d1afbf1b139d06c6beb42eb513c9aba924c412a2e640fa2263a47dbeb3a2fb764736f6c63430008150033"

describe("bytecode validation logic", () => {
  it("detects V1 bytecode", () => {
    expect(isMorphoChainlinkOracleV1Bytecode(MORPHO_CHAINLINK_ORACLE_V1_TEST_BYTECODE)).toBe(true);
    expect(classifyOracleBytecode(MORPHO_CHAINLINK_ORACLE_V1_TEST_BYTECODE)).toBe("v1");
  });

  // TODO: add a real V2 bytecode sample for testing once available.
  it("detects V2 bytecode", () => {
    expect(isMorphoChainlinkOracleV2Bytecode(MORPHO_CHAINLINK_ORACLE_V2_COMMON)).toBe(true);
    expect(classifyOracleBytecode(MORPHO_CHAINLINK_ORACLE_V2_COMMON)).toBe("v2");
  });
});
