import { getClient } from "./morphoFactory.js";
import type { Address, ChainId, StandardOracleFeeds } from "../types.js";
import { abi as MORPHO_CHAINLINK_V1_ABI } from "../abi/morpho-chainlink-oracle-v1.js";

const ZERO_ADDRESS = "0x0000000000000000000000000000000000000000";

/**
 * MorphoChainlinkOracle V1 reference bytecode (already normalized - PUSH32 values zeroed).
 * Generated by normalizing any V1 deployed bytecode.
 */
const MORPHO_V1_NORMALIZED_BYTECODE =
  "0x60806040818152600436101561001457600080fd5b600091823560e01c908163411557d1146104455750806356095e11146103d7578063a035b1fe14610277578063acfbd39e14610209578063ce4b5bbe146101b1578063d6c843ca14610159578063dc53858c146100eb5763f50a47181461007a57600080fd5b346100e757817f00000000000000000000000000000000000000000000000000000000000000003601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b5080fd5b50346100e757817f00000000000000000000000000000000000000000000000000000000000000003601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100e757817f00000000000000000000000000000000000000000000000000000000000000003601126100e757602090517f00000000000000000000000000000000000000000000000000000000000000008152f35b50346100e757817f00000000000000000000000000000000000000000000000000000000000000003601126100e757602090517f00000000000000000000000000000000000000000000000000000000000000008152f35b50346100e757817f00000000000000000000000000000000000000000000000000000000000000003601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346100e757817f00000000000000000000000000000000000000000000000000000000000000003601126100e7576020906103d061035461032b6102fc7f00000000000000000000000000000000000000000000000000000000000000007f0000000000000000000000000000000000000000000000000000000000000000610821565b6103257f000000000000000000000000000000000000000000000000000000000000000061067c565b906104b3565b6103257f000000000000000000000000000000000000000000000000000000000000000061067c565b6103a96103807f000000000000000000000000000000000000000000000000000000000000000061067c565b6103257f000000000000000000000000000000000000000000000000000000000000000061067c565b907f00000000000000000000000000000000000000000000000000000000000000006104f5565b9051908152f35b50346100e757817f00000000000000000000000000000000000000000000000000000000000000003601126100e7576020905173ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b8390346100e757817f00000000000000000000000000000000000000000000000000000000000000003601126100e75760209073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b818102929181159184041417156104c657565b7f0000000000000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b9091828202917f0000000000000000000000000000000000000000000000000000000000000000848209938380861095039480860395146105b357848311156105895782910981600003821680920460028082600302188083028203028083028203028083028203028083028203028083028203028092029003029360018380600003040190848311900302920304170290565b60046040517f00000000000000000000000000000000000000000000000000000000000000008152fd5b5050809250156105c1570490565b7f0000000000000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b90601f7f0000000000000000000000000000000000000000000000000000000000000000910116810190811067ffffffffffffffff82111761063157604052565b7f0000000000000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b519069ffffffffffffffffffff8216820361067757565b600080fd5b73ffffffffffffffffffffffffffffffffffffffff16801561081b5760049060a06040918251938480927f000000000000000000000000000000000000000000000000000000000000000082525afa918215610810576000926107bf575b50805181810181811067ffffffffffffffff821117610631578252600f81526020917f0000000000000000000000000000000000000000000000000000000000000000838301526000841261072f5750505090565b5180927f0000000000000000000000000000000000000000000000000000000000000000825280600483015282519283602484015260005b8481106107a8575050507f0000000000000000000000000000000000000000000000000000000000000000601f836000604480968601015201168101030190fd5b818101830151868201604401528593508201610767565b909160a0823d8211610808575b816107d960a093836105f0565b8101031261080557506107eb81610660565b506107fd608060208301519201610660565b5090386106da565b80fd5b3d91506107cc565b50513d6000823e3d90fd5b50600190565b73ffffffffffffffffffffffffffffffffffffffff169081156108c0576020906024604051809481937f0000000000000000000000000000000000000000000000000000000000000000835260048301525afa9081156108b457600091610886575090565b906020823d82116108ac575b8161089f602093836105f0565b8101031261080557505190565b3d9150610892565b6040513d6000823e3d90fd5b505060019056fea26469706673582212206d1afbf1b139d06c6beb42eb513c9aba924c412a2e640fa2263a47dbeb3a2fb764736f6c63430008150033";

/**
 * Normalize bytecode by replacing PUSH32 (0x7f) values with zeros.
 * This allows comparing bytecode regardless of immutable values.
 */
function normalizeBytecode(bytecode: string): string {
  let hex = bytecode.toLowerCase();
  if (hex.startsWith("0x")) hex = hex.slice(2);

  let result = "";
  let i = 0;

  while (i < hex.length) {
    const opcode = hex.slice(i, i + 2);
    result += opcode;
    i += 2;

    // PUSH32 = 0x7f, followed by 32 bytes (64 hex chars)
    if (opcode === "7f" && i + 64 <= hex.length) {
      result += "0000000000000000000000000000000000000000000000000000000000000000";
      i += 64;
    }
  }

  return "0x" + result;
}

function toNullableAddress(addr: Address): Address | null {
  return addr === ZERO_ADDRESS ? null : addr;
}

export interface V1DetectionResult {
  isV1: boolean;
  feeds: StandardOracleFeeds | null;
}

/**
 * Check if bytecode matches MorphoChainlinkOracle V1.
 * Normalizes deployed bytecode (masks PUSH32 immutables) and compares.
 */
async function isMorphoChainlinkOracleV1Bytecode(
  chainId: ChainId,
  oracleAddress: Address
): Promise<boolean> {
  const client = getClient(chainId);

  try {
    const deployedBytecode = await client.getCode({ address: oracleAddress });
    if (!deployedBytecode) return false;

    const normalizedDeployed = normalizeBytecode(deployedBytecode);
    return normalizedDeployed === MORPHO_V1_NORMALIZED_BYTECODE;
  } catch {
    return false;
  }
}

/**
 * Fetch feeds from a verified V1 oracle.
 */
async function fetchV1OracleFeeds(
  chainId: ChainId,
  oracleAddress: Address
): Promise<StandardOracleFeeds | null> {
  const client = getClient(chainId);

  try {
    const results = await client.multicall({
      contracts: [
        {
          address: oracleAddress,
          abi: MORPHO_CHAINLINK_V1_ABI,
          functionName: "BASE_FEED_1",
        },
        {
          address: oracleAddress,
          abi: MORPHO_CHAINLINK_V1_ABI,
          functionName: "BASE_FEED_2",
        },
        {
          address: oracleAddress,
          abi: MORPHO_CHAINLINK_V1_ABI,
          functionName: "QUOTE_FEED_1",
        },
        {
          address: oracleAddress,
          abi: MORPHO_CHAINLINK_V1_ABI,
          functionName: "QUOTE_FEED_2",
        },
      ],
      allowFailure: true,
    });

    if (results.some((r) => r.status !== "success")) {
      return null;
    }

    const [baseFeedOne, baseFeedTwo, quoteFeedOne, quoteFeedTwo] = results.map(
      (r) => r.result
    ) as [Address, Address, Address, Address];

    return {
      baseFeedOne: toNullableAddress(baseFeedOne.toLowerCase() as Address),
      baseFeedTwo: toNullableAddress(baseFeedTwo.toLowerCase() as Address),
      quoteFeedOne: toNullableAddress(quoteFeedOne.toLowerCase() as Address),
      quoteFeedTwo: toNullableAddress(quoteFeedTwo.toLowerCase() as Address),
      baseVault: null,
      quoteVault: null,
      baseVaultConversionSample: 0n,
      quoteVaultConversionSample: 0n,
    };
  } catch {
    return null;
  }
}

/**
 * Detect V1 oracle by bytecode verification, then fetch feeds if verified.
 * 1. First verify bytecode matches V1 pattern
 * 2. Only then fetch feeds
 */
export async function detectAndFetchV1Oracle(
  chainId: ChainId,
  oracleAddress: Address
): Promise<V1DetectionResult> {
  // Step 1: Verify bytecode
  const isV1 = await isMorphoChainlinkOracleV1Bytecode(chainId, oracleAddress);
  if (!isV1) {
    return { isV1: false, feeds: null };
  }

  // Step 2: Bytecode verified - now fetch feeds
  const feeds = await fetchV1OracleFeeds(chainId, oracleAddress);
  if (!feeds) {
    return { isV1: true, feeds: null };
  }

  return { isV1: true, feeds };
}
